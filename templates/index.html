{# templates/index.html #}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
  <title>TTH NFT</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@700&display=swap"
        rel="stylesheet">
  <!-- –í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π CSS -->
  <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
  <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
    {% if user %}
      <span class="navbar-brand balance-box">
        üíé {{ user.balance|default(0) }}
      </span>
    {% else %}
      <a class="navbar-brand" href="/">TTH NFT</a>
    {% endif %}
    <div class="ml-auto d-flex align-items-center">
      {% if user %}
        <a href="/profile/{{ user_id }}" class="mr-3">
          {% if user.photo_url.endswith('.mp4') or user.photo_url[-3:]|lower == 'gif' %}
            <video class="profile-avatar"
                   autoplay loop muted playsinline preload="none"
                   style="width:30px;height:30px;border-radius:50%;object-fit:cover;border:2px solid #fff;">
              <source src="{{ user.photo_url }}" type="video/mp4">
            </video>
          {% else %}
            <img src="{{ user.photo_url }}" alt="Avatar"
                 class="profile-avatar" loading="lazy">
          {% endif %}
        </a>
        <a href="/logout" class="btn btn-sm btn-outline-danger mr-2">–í—ã–π—Ç–∏</a>
      {% else %}
        <a href="/login" class="btn btn-sm btn-outline-primary mr-2">–í–æ–π—Ç–∏</a>
      {% endif %}
      <button type="button" class="btn btn-link p-0 mr-2"
              data-toggle="modal" data-target="#tokenSearchModal"
              title="–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω">
        <img src="/static/butons/lupa.png" alt="–ü–æ–∏—Å–∫"
             style="width:30px;height:30px;" loading="lazy">
      </button>
    </div>
  </nav>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <div class="content">
    <div class="container my-4">

      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
      <div class="row main-buttons justify-content-center flex-nowrap">
        {% set btns = [
          ('/mint','create.png','–°–æ–∑–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä'),
          ('/sell','sell.png','–ü—Ä–æ–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä'),
          ('/auctions','auction.png','–ê—É–∫—Ü–∏–æ–Ω'),
          ('/exchange','exchange.png','–û–±–º–µ–Ω<br>–Ω–æ–º–µ—Ä–∞–º–∏'),
          ('/transfer','transfer.png','–ü–µ—Ä–µ–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä'),
          ('/participants','liderboard.png','–°–ø–∏—Å–æ–∫ –ª–∏–¥–µ—Ä–æ–≤'),
          ('/assets','activity.png','–ê–∫—Ç–∏–≤—ã')
        ] %}
        {% for href,icon,label in btns %}
          <div class="col-auto text-center">
            <a href="{{ href }}" class="btn-icon">
              <img src="/static/butons/{{ icon }}" alt="{{ label|striptags }}"
                   loading="lazy">
              <small>{{ label|safe }}</small>
            </a>
          </div>
        {% endfor %}
      </div>

      <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
      <div class="sort-container">
        <button id="toggle-sort" class="btn btn-secondary btn-block">
          –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å <span id="sort-arrow">&#9660;</span>
        </button>
        <div id="sort-options" class="mt-2" style="display:none;">
          <div class="sort-options-rows">
            <div class="row">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn sort-btn" data-sort="token-length-asc">
                  –ú–µ–Ω—å—à–µ —Ü–∏—Ñ—Ä
                </button>
                <button type="button" class="btn sort-btn" data-sort="repeats-desc">
                  –ë–æ–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä–æ–≤
                </button>
                <button type="button" class="btn sort-btn" data-sort="bg-rarity-asc">
                  –†–µ–¥–∫–∏–µ —Ñ–æ–Ω—ã
                </button>
              </div>
            </div>
            <div class="row mt-2">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn sort-btn" data-sort="price-asc">
                  –¶–µ–Ω–∞: –Ω–∏–∂–µ
                </button>
                <button type="button" class="btn sort-btn" data-sort="price-desc">
                  –¶–µ–Ω–∞: –¥–æ—Ä–æ–∂–µ
                </button>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ–Ω—É:</label>
            <div id="custom-bg-filter">
              <div class="selected">
                <div class="color-circle" style="background:#fff;"></div>
                <span>–í—Å–µ —Ü–≤–µ—Ç–∞</span>
              </div>
              <ul></ul>
            </div>
          </div>
        </div>
      </div>

      {% if user %}
      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <ul class="nav nav-tabs" id="numbersTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="sale-numbers-tab" data-toggle="tab"
             href="#sale-numbers" role="tab">–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="my-numbers-tab" data-toggle="tab"
             href="#my-numbers" role="tab">–ú–æ–∏ –Ω–æ–º–µ—Ä–∞</a>
        </li>
      </ul>
      <div class="tab-content" id="numbersTabContent">
        <div class="tab-pane fade show active" id="sale-numbers" role="tabpanel">
          <h1 class="mb-4">–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</h1>
          <div class="row">
            {% for listing in market %}
              <div class="col-md-6">
                <div class="market-card"
                     data-token="{{ listing.token.token }}"
                     data-token-length="{{ listing.token.token|length }}"
                     data-repeats="{{ listing.token.max_repeats }}"
                     data-price="{{ listing.price }}"
                     data-bg-rarity="{{ listing.token.bg_rarity[:-1]|float }}"
                     data-bg-color="{{ listing.token.bg_color }}"
                     data-toggle="modal"
                     data-target="#listingModal-{{ listing.token.token }}"
                     {% if listing.token.bg_is_image %}
                       style="
                         background: url('{{ listing.token.bg_color }}')
                           no-repeat center/cover;
                         color: {{ listing.token.text_color }};
                         {% if listing.token.bg_rarity=='0.1%' %}border:3px solid gold;{% endif %}"
                     {% elif 'linear-gradient' in listing.token.bg_color %}
                       style="background: {{ listing.token.bg_color }};
                              color: {{ listing.token.text_color }};"
                     {% else %}
                       style="background-color: {{ listing.token.bg_color }};
                              color: {{ listing.token.text_color }};"
                     {% endif %}>
                  {% if listing.token.overall_rarity!='–û–±—ã—á–Ω—ã–π' %}
                    <div class="rarity-badge">
                      {{ listing.token.overall_rarity }}
                    </div>
                  {% endif %}
                  <div class="market-number">
                    {% if 'linear-gradient' in listing.token.text_color %}
                      <span style="
                        background: {{ listing.token.text_color }};
                        -webkit-background-clip: text;
                        color: transparent;">
                        {{ listing.token.token }}
                      </span>
                    {% else %}
                      <span style="color: {{ listing.token.text_color }};">
                        {{ listing.token.token }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="market-info">
                    <p>–¶–µ–Ω–∞: {{ listing.price }} üíé</p>
                    <p>–ü—Ä–æ–¥–∞–≤–µ—Ü:
                      {{ users.get(listing.seller_id,{}).get('username',listing.seller_id) }}
                    </p>
                  </div>
                  {% if listing.token.bg_availability %}
                    <div class="token-availability">
                      {{ listing.token.bg_availability
                          |replace("–ù–∞–ª–∏—á–∏–µ: ","")
                          |replace("/"," –∏–∑ ") }}
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="tab-pane fade" id="my-numbers" role="tabpanel">
          <h1 class="mb-4">–ú–æ–∏ –Ω–æ–º–µ—Ä–∞</h1>
          <div class="row">
            {% set mine = market|selectattr("seller_id","equalto",user_id)|list %}
            {% if mine %}
              {% for listing in mine %}
                {# –∫–æ–ø–∏—è –±–ª–æ–∫–∞ –≤—ã—à–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ #}
                <div class="col-md-6">
                  <div class="market-card"
                       data-token="{{ listing.token.token }}"
                       ‚Ä¶ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ sale-numbers) ‚Ä¶>
                    ‚Ä¶ –∫–æ–Ω—Ç–µ–Ω—Ç ‚Ä¶
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="col-12"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ.</p></div>
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <h1 class="mb-4">–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</h1>
      <div class="row">
        {# –ø–æ–≤—Ç–æ—Ä sale-numbers #}
      </div>
      {% endif %}

    </div>
  </div>

  {# –ú–æ–¥–∞–ª–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∏–Ω–≥–∞ #}
  {% for listing in market %}
    <!-- –î–µ—Ç–∞–ª–∏ -->
    <div class="modal fade" id="listingModal-{{ listing.token.token }}"
         tabindex="-1" role="dialog" ‚Ä¶
         aria-labelledby="listingModalLabel-{{ listing.token.token }}">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header token-details">
            <h5 class="modal-title"
                id="listingModalLabel-{{ listing.token.token }}">
              –î–µ—Ç–∞–ª–∏ –Ω–æ–º–µ—Ä–∞
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <div class="market-card modal-token-card"
                   {% if listing.token.bg_is_image %}
                     style="
                       background: url('{{ listing.token.bg_color }}')
                         no-repeat center/cover;
                       color: {{ listing.token.text_color }};
                       {% if listing.token.bg_rarity=='0.1%' %}
                         border:3px solid gold;
                       {% endif %}" ‚Ä¶
                   {% endif %}>
                <h4 class="market-number"
                    {% if 'linear-gradient' in listing.token.text_color %}
                      style="
                        background: {{ listing.token.text_color }};
                        -webkit-background-clip: text;
                        color: transparent;"
                    {% else %}
                      style="color:{{ listing.token.text_color }};"
                    {% endif %}>
                  {{ listing.token.token }}
                </h4>
              </div>
            </div>
            <p><strong>–†–µ–¥–∫–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞:</strong> {{ listing.token.number_rarity }}</p>
            <p><strong>–†–µ–¥–∫–æ—Å—Ç—å —Ü–∏—Ñ—Ä:</strong> {{ listing.token.text_rarity }}</p>
            <p><strong>–†–µ–¥–∫–æ—Å—Ç—å —Ñ–æ–Ω–∞:</strong> {{ listing.token.bg_rarity }}</p>
            <p><strong>–û–±—â–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å:</strong> {{ listing.token.overall_rarity }}</p>
            <p><strong>–¶–µ–Ω–∞:</strong> {{ listing.price }} üíé</p>
            <p><strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong>
              {{ users.get(listing.seller_id,{}).get('username',listing.seller_id) }}
            </p>
            {% if listing.token.bg_availability %}
              <p><strong>–ù–∞–ª–∏—á–∏–µ:</strong>
                {{ listing.token.bg_availability
                    |replace("–ù–∞–ª–∏—á–∏–µ: ","")
                    |replace("/"," –∏–∑ ") }}
              </p>
            {% endif %}
          </div>
          <div class="modal-footer">
            {% if user and user_id==listing.seller_id %}
              <button type="button" class="btn btn-warning mr-2"
                      data-toggle="modal"
                      data-target="#updatePriceModal-{{ listing.token.token }}">
                –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É
              </button>
              <form action="/withdraw" method="post" class="d-inline">
                <input type="hidden" name="market_index"
                       value="{{ listing.token.token }}">
                <button class="btn btn-danger">–°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏</button>
              </form>
            {% else %}
              <form action="/buy/{{ listing.token.token }}"
                    method="post" class="d-inline">
                {% if buyer_id %}
                  <input type="hidden" name="buyer_id"
                         value="{{ buyer_id }}">
                {% endif %}
                <button class="btn btn-primary">–ö—É–ø–∏—Ç—å</button>
              </form>
              <button class="btn btn-info ml-2"
                      data-toggle="modal"
                      data-target="#offerModal-{{ listing.token.token }}">
                –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É
              </button>
            {% endif %}
            <button class="btn btn-secondary" data-dismiss="modal">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>

    {% if user and user_id==listing.seller_id %}
      <!-- –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É -->
      <div class="modal fade" id="updatePriceModal-{{ listing.token.token }}"
           tabindex="-1" role="dialog" ‚Ä¶>
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header token-details">
              <h5 class="modal-title"
                  id="updatePriceModalLabel-{{ listing.token.token }}">
                –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É
              </h5>
              <button class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <form action="/updateprice" method="post">
              <div class="modal-body">
                <input type="hidden" name="market_index"
                       value="{{ listing.token.token }}">
                <div class="form-group">
                  <label for="newPriceInput-{{ listing.token.token }}">
                    –ù–æ–≤–∞—è —Ü–µ–Ω–∞
                  </label>
                  <input type="number" class="form-control"
                         id="newPriceInput-{{ listing.token.token }}"
                         name="new_price" required>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-warning">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary"
                        data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É -->
    <div class="modal fade" id="offerModal-{{ listing.token.token }}"
         tabindex="-1" role="dialog" ‚Ä¶>
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"
                id="offerModalLabel-{{ listing.token.token }}">
              –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è –Ω–æ–º–µ—Ä–∞ {{ listing.token.token }}
            </h5>
            <button class="close" data-dismiss="modal"><span>&times;</span></button>
          </div>
          <form action="/offer" method="post">
            <div class="modal-body">
              <input type="hidden" name="token_value"
                     value="{{ listing.token.token }}">
              <div class="form-group">
                <label for="offerPriceInput-{{ listing.token.token }}">
                  –í–∞—à–∞ —Ü–µ–Ω–∞ (üíé):
                </label>
                <input type="number" class="form-control"
                       id="offerPriceInput-{{ listing.token.token }}"
                       name="proposed_price" required>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
              <button class="btn btn-secondary"
                      data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- –ü–æ–∏—Å–∫ —Ç–æ–∫–µ–Ω–∞ -->
  <div class="modal fade" id="tokenSearchModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <form onsubmit="return redirectToToken(event);">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω</h5>
            <button class="close" data-dismiss="modal"><span>&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="tokenNumberInput">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–æ–∫–µ–Ω–∞</label>
              <input type="text" class="form-control" id="tokenNumberInput"
                     placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1234" required>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary">–ò—Å–∫–∞—Ç—å</button>
            <button class="btn btn-secondary"
                    data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- –û—à–∏–±–∫–∞ -->
  <div class="modal fade" id="errorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–û—à–∏–±–∫–∞</h5>
          <button class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.</div>
        <div class="modal-footer">
          <button class="btn btn-secondary"
                  data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ù–∞–≤–µ—Ä—Ö -->
  <button id="scrollToTopBtn" onclick="scrollToTop()">&#8593;</button>

  <!-- jQuery/Popper/Bootstrap JS + –≤–∞—à —Å–∫—Ä–∏–ø—Ç -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="/static/js/index.js"></script>
</body>
</html>
