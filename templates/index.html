<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
  <title>TTH NFT</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; overflow: hidden; }
    .navbar.fixed-top { height: 60px; }
    .content {
      position: absolute; top: 60px; left: 0; right: 0; bottom: 0;
      overflow-y: auto; padding: 10px;
    }
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Noto Sans JP', sans-serif; color: #333;
    }
    .navbar { padding: 0.5rem 1rem; }
    .navbar-brand { font-size: 1.5rem; }
    .balance-box {
      display: inline-block; background: #e0e0e0; padding: 5px 12px;
      border-radius: 20px; font-size: 0.9rem; font-weight: bold; color: #333;
    }
    .profile-avatar {
      width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;
    }
    .main-buttons { margin: 1rem 0; }
    .main-buttons .btn-icon { display:block; text-align:center; text-decoration:none; color:inherit; margin:0 0.005rem; width:23px; }
    .main-buttons .btn-icon img { display:block; margin:0 auto; max-width:24px; max-height:24px; }
    .main-buttons .btn-icon small { display:block; margin-top:0.05rem; font-size:0.6rem; white-space:normal; line-height:1.1; }

    .market-card {
      border: none; border-radius: 15px; padding: 20px; margin-bottom: 0 !important;
      text-align: center; cursor: pointer; position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.03));
    }
    .market-card:hover { transform: scale(1.05); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .col-md-6 { padding-bottom: 20px; }
    .market-number { font-family: 'Lato', sans-serif; font-size: 2.5rem; font-weight: 700; margin: 0; }
    .market-info p { margin: 0; font-size: 1rem; }
    .rarity-badge {
      position: absolute; top: 10px; right: 10px; background-color: #ff9800; color:#fff;
      padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight:600;
    }
    .token-availability {
      position: absolute; bottom: 10px; right: 10px;
      background: linear-gradient(90deg,#ffd700,#ffa500); color:#fff; font-size:0.8rem; padding:4px 8px; border-radius:4px;
    }
    .modal-content { border-radius:15px; border:none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background-color:#fff; color:#333; }
    .modal-header, .modal-footer { border:none; background:none; }
    .modal-token-card { padding:50px !important; border:1px solid #ddd; border-radius:15px; transition:none !important; }
    .modal-token-card:hover { transform:none !important; box-shadow:none !important; }
    h1.mb-4 { font-size:2rem; }
    .sort-container .btn { padding:0.4rem 0.8rem; font-size:0.9rem; margin:0.2rem; border-radius:20px; background-color:#e0e0e0; color:#333; border:none; transition:background-color 0.3s, color 0.3s; }
    .sort-container .btn:hover { background-color:#d0d0d0; color:#333; }
    .sort-options-rows { display:flex; flex-direction:column; align-items:center; }
    #custom-bg-filter { position:relative; display:inline-block; cursor:pointer; border:1px solid #ccc; border-radius:5px; padding:5px 10px; background:#fff; min-width:220px; }
    #custom-bg-filter .selected { display:flex; align-items:center; }
    #custom-bg-filter .color-circle { width:20px; height:20px; border-radius:50%; margin-right:10px; background-size:cover; border:1px solid #aaa; }
    #custom-bg-filter ul { display:none; position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ccc; border-radius:5px; margin:0; padding:0; list-style:none; z-index:1000; min-width:220px; }
    #custom-bg-filter ul li { padding:8px 15px; cursor:pointer; display:flex; align-items:center; white-space:nowrap; }
    #custom-bg-filter ul li:hover { background-color:#f0f0f0; }

    .card-wrapper { position:relative; }
    .order-badge {
      position:absolute; left:-40px; top:50%; transform:translateY(-50%); font-size:2rem; font-weight:bold; line-height:1; width:35px; text-align:right; color:#333; pointer-events:none;
    }
    .btn-icon { display:inline-block; text-align:center; margin:0 0.005rem; }
    .btn-icon img { display:block; margin:0 auto; max-width:24px; max-height:24px; }
    .btn-icon small { display:block; margin-top:0.05rem; font-size:0.6rem; }
    .btn-circle { width:36px; height:36px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center; }
    .buy-btn, .btn-secondary.btn-block[disabled] { border-radius:15px !important; }

    #scrollToTopBtn {
      position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: #6c757d; color:#fff; border:none; border-radius:50%; display:none; align-items:center; justify-content:center; font-size:24px; cursor:pointer; z-index:1000; box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    @media (max-width:576px){
      .sort-container { font-size:0.8rem; }
      .sort-container .btn { padding:0.25rem 0.4rem; font-size:0.8rem; }
    }
  </style>
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ user –∏ user_id –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å -->
  <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
    <span id="balanceValue" class="navbar-brand balance-box">üíé {{ user.balance|default(0) }}</span>

    <div class="ml-auto d-flex align-items-center">
      {% if user.photo_url %}
        <a href="/profile/{{ user_id }}" class="mr-3">
          {% if user.photo_url.endswith('.mp4') or user.photo_url[-3:]|lower == 'gif' %}
            <video class="profile-avatar" autoplay loop muted playsinline style="width:30px;height:30px;border-radius:50%;object-fit:cover;border:2px solid #fff;">
              <source src="{{ user.photo_url }}" type="video/mp4">
            </video>
          {% else %}
            <img src="{{ user.photo_url }}" alt="Avatar" class="profile-avatar">
          {% endif %}
        </a>
      {% else %}
        <a href="/profile/{{ user_id }}" class="mr-3 btn btn-sm btn-outline-primary">–ü—Ä–æ—Ñ–∏–ª—å</a>
      {% endif %}

      <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
      <button type="button" class="btn btn-link p-0 mr-2" data-toggle="modal" data-target="#tokenSearchModal" title="–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω">
        <img src="/static/butons/lupa.png" alt="–ü–æ–∏—Å–∫" style="width:30px; height:30px;">
      </button>
    </div>
  </nav>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <div class="content">
    <div class="container my-4">
      <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
      <div class="row main-buttons justify-content-center flex-nowrap">
        <div class="col-auto text-center">
          <a href="/mint" class="btn-icon">
            <img src="/static/butons/create.png" alt="–°–æ–∑–¥–∞—Ç—å –Ω–æ–º–µ—Ä">
            <small>–°–æ–∑–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/sell" class="btn-icon">
            <img src="/static/butons/sell.png" alt="–ü—Ä–æ–¥–∞—Ç—å –Ω–æ–º–µ—Ä">
            <small>–ü—Ä–æ–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/auctions" class="btn-icon">
            <img src="/static/butons/auction.png" alt="–ê—É–∫—Ü–∏–æ–Ω">
            <small>–ê—É–∫—Ü–∏–æ–Ω</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/exchange" class="btn-icon">
            <img src="/static/butons/exchange.png" alt="–û–±–º–µ–Ω –Ω–æ–º–µ—Ä–∞–º–∏">
            <small>–û–±–º–µ–Ω<br>–Ω–æ–º–µ—Ä–∞–º–∏</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/transfer" class="btn-icon">
            <img src="/static/butons/transfer.png" alt="–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–æ–º–µ—Ä">
            <small>–ü–µ—Ä–µ–¥–∞—Ç—å<br>–Ω–æ–º–µ—Ä</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/participants" class="btn-icon">
            <img src="/static/butons/liderboard.png" alt="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
            <small>–°–ø–∏—Å–æ–∫ –ª–∏–¥–µ—Ä–æ–≤</small>
          </a>
        </div>
        <div class="col-auto text-center">
          <a href="/assets" class="btn-icon">
            <img src="/static/butons/activity.png" alt="–ê–∫—Ç–∏–≤—ã">
            <small>–ê–∫—Ç–∏–≤—ã</small>
          </a>
        </div>
      </div>

      <!-- –ë–ª–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
      <div class="sort-container">
        <button id="toggle-sort" class="btn btn-secondary btn-block">
          –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å <span id="sort-arrow">&#9660;</span>
        </button>
        <div id="sort-options" class="mt-2" style="display: none;">
          <div class="sort-options-rows">
            <div class="row">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn sort-btn" data-sort="token-length-asc">–ú–µ–Ω—å—à–µ —Ü–∏—Ñ—Ä</button>
                <button type="button" class="btn sort-btn" data-sort="repeats-desc">–ë–æ–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä–æ–≤</button>
                <button type="button" class="btn sort-btn" data-sort="bg-rarity-asc">–†–µ–¥–∫–∏–µ —Ñ–æ–Ω—ã</button>
              </div>
            </div>
            <div class="row mt-2">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn sort-btn" data-sort="price-asc">–¶–µ–Ω–∞: –Ω–∏–∂–µ</button>
                <button type="button" class="btn sort-btn" data-sort="price-desc">–¶–µ–Ω–∞: –¥–æ—Ä–æ–∂–µ</button>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ–Ω—É:</label>
            <div id="custom-bg-filter">
              <div class="selected">
                <div class="color-circle" style="background: #fff;"></div>
                <span>–í—Å–µ —Ü–≤–µ—Ç–∞</span>
              </div>
              <ul></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
      <ul class="nav nav-tabs" id="numbersTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="sale-numbers-tab" data-toggle="tab" href="#sale-numbers" role="tab" aria-controls="sale-numbers" aria-selected="true">–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="my-numbers-tab" data-toggle="tab" href="#my-numbers" role="tab" aria-controls="my-numbers" aria-selected="false">–ú–æ–∏ –Ω–æ–º–µ—Ä–∞</a>
        </li>
      </ul>

      <div class="tab-content" id="numbersTabContent">
        <!-- "–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ" -->
        <div class="tab-pane fade show active" id="sale-numbers" role="tabpanel" aria-labelledby="sale-numbers-tab">
          <h1 class="mb-4">–ù–æ–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</h1>
          <div class="row">
            {% for listing in market %}
              <div class="col-md-6">
                <div class="market-card"
                     data-token="{{ listing.token.token }}"
                     data-token-length="{{ listing.token.token|length }}"
                     data-repeats="{{ listing.token.max_repeats }}"
                     data-price="{{ listing.price }}"
                     data-bg-rarity="{{ listing.token.bg_rarity[:-1]|float }}"
                     data-bg-color="{{ listing.token.bg_color }}"
                     {% if listing.token.bg_is_image %}
                       {% if listing.token.bg_rarity == "0.1%" %}
                         style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }}; border: 3px solid gold;"
                       {% else %}
                         style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }};"
                       {% endif %}
                     {% else %}
                       {% if 'linear-gradient' in listing.token.bg_color %}
                         style="background: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                       {% else %}
                         style="background-color: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                       {% endif %}
                     {% endif %}
                     data-toggle="modal" data-target="#listingModal-{{ listing.token.token }}">
                  {% if listing.token.overall_rarity and listing.token.overall_rarity != '–û–±—ã—á–Ω—ã–π' %}
                    <div class="rarity-badge">{{ listing.token.overall_rarity }}</div>
                  {% endif %}
                  <div class="market-number">
                    {% if 'linear-gradient' in listing.token.text_color %}
                      <span style="background: {{ listing.token.text_color }}; -webkit-background-clip: text; color: transparent;">
                        {{ listing.token.token }}
                      </span>
                    {% else %}
                      <span style="color: {{ listing.token.text_color }};">
                        {{ listing.token.token }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="market-info">
                    <p>–¶–µ–Ω–∞: {{ listing.price }} üíé</p>
                    <p>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ users.get(listing.seller_id, {}).get('username', listing.seller_id) }}</p>
                  </div>
                  {% if listing.token.bg_availability %}
                    <div class="token-availability">
                      {{ listing.token.bg_availability | replace("–ù–∞–ª–∏—á–∏–µ: ", "") | replace("/", " –∏–∑ ") }}
                    </div>
                  {% endif %}
                </div>

                {% if user_id == listing.seller_id %}
                  <button class="btn btn-secondary btn-block" disabled style="margin-top:10px;">–≠—Ç–æ –≤–∞—à –Ω–æ–º–µ—Ä</button>
                {% else %}
                  <button class="btn btn-primary btn-block buy-btn" style="margin-top:10px;" data-token="{{ listing.token.token }}" data-price="{{ listing.price }}">
                    –ö—É–ø–∏—Ç—å –∑–∞ {{ listing.price }} üíé
                  </button>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- "–ú–æ–∏ –Ω–æ–º–µ—Ä–∞" -->
        <div class="tab-pane fade" id="my-numbers" role="tabpanel" aria-labelledby="my-numbers-tab">
          <h1 class="mb-4">–ú–æ–∏ –Ω–æ–º–µ—Ä–∞</h1>
          <div class="row">
            {% set my_listings = market | selectattr("seller_id", "equalto", user_id) | list %}
            {% if my_listings %}
              {% for listing in my_listings %}
                <div class="col-md-6">
                  <div class="market-card"
                       data-token="{{ listing.token.token }}"
                       data-token-length="{{ listing.token.token|length }}"
                       data-repeats="{{ listing.token.max_repeats }}"
                       data-price="{{ listing.price }}"
                       data-bg-rarity="{{ listing.token.bg_rarity[:-1]|float }}"
                       data-bg-color="{{ listing.token.bg_color }}"
                       {% if listing.token.bg_is_image %}
                         {% if listing.token.bg_rarity == "0.1%" %}
                           style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }}; border: 3px solid gold;"
                         {% else %}
                           style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }};"
                         {% endif %}
                       {% else %}
                         {% if 'linear-gradient' in listing.token.bg_color %}
                           style="background: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                         {% else %}
                           style="background-color: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                         {% endif %}
                       {% endif %}
                       data-toggle="modal" data-target="#listingModal-{{ listing.token.token }}">
                    {% if listing.token.overall_rarity and listing.token.overall_rarity != '–û–±—ã—á–Ω—ã–π' %}
                      <div class="rarity-badge">{{ listing.token.overall_rarity }}</div>
                    {% endif %}
                    <div class="market-number">
                      {% if 'linear-gradient' in listing.token.text_color %}
                        <span style="background: {{ listing.token.text_color }}; -webkit-background-clip: text; color: transparent;">
                          {{ listing.token.token }}
                        </span>
                      {% else %}
                        <span style="color: {{ listing.token.text_color }};">
                          {{ listing.token.token }}
                        </span>
                      {% endif %}
                    </div>
                    <div class="market-info">
                      <p>–¶–µ–Ω–∞: {{ listing.price }} üíé</p>
                      <p>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ users.get(listing.seller_id, {}).get('username', listing.seller_id) }}</p>
                    </div>
                    {% if listing.token.bg_availability %}
                      <div class="token-availability">
                        {{ listing.token.bg_availability | replace("–ù–∞–ª–∏—á–∏–µ: ", "") | replace("/", " –∏–∑ ") }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="col-12"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ.</p></div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
  {% for listing in market %}
    <div class="modal fade" id="listingModal-{{ listing.token.token }}" tabindex="-1" role="dialog" aria-labelledby="listingModalLabel-{{ listing.token.token }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header token-details d-flex align-items-center justify-content-between">
            <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –Ω–æ–º–µ—Ä–∞ {{ listing.token.token }}</h5>
            <div class="d-flex">
              <button type="button" class="btn btn-light btn-circle mr-2" data-token="{{ listing.token.token }}" id="shareBtn-{{ listing.token.token }}" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                <img src="/static/butons/share.png" alt="Share" style="width:20px;height:20px">
              </button>
              <button type="button" class="close" data-dismiss="modal">√ó</button>
            </div>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <div class="market-card modal-token-card"
                {% if listing.token.bg_is_image %}
                  {% if listing.token.bg_rarity == "0.1%" %}
                    style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }}; border: 3px solid gold;"
                  {% else %}
                    style="background: url('{{ listing.token.bg_color }}') no-repeat center/cover; color: {{ listing.token.text_color }};"
                  {% endif %}
                {% else %}
                  {% if 'linear-gradient' in listing.token.bg_color %}
                    style="background: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                  {% else %}
                    style="background-color: {{ listing.token.bg_color }}; color: {{ listing.token.text_color }};"
                  {% endif %}
                {% endif %}>
                {% if 'linear-gradient' in listing.token.text_color %}
                  <h4 class="market-number" style="background: {{ listing.token.text_color }}; -webkit-background-clip: text; color: transparent;">
                    {{ listing.token.token }}
                  </h4>
                {% else %}
                  <h4 class="market-number" style="color: {{ listing.token.text_color }};">
                    {{ listing.token.token }}
                  </h4>
                {% endif %}
              </div>
            </div>
            <div>
              <p><strong>–†–µ–¥–∫–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞:</strong> {{ listing.token.number_rarity }}</p>
              <p><strong>–†–µ–¥–∫–æ—Å—Ç—å —Ü–∏—Ñ—Ä:</strong> {{ listing.token.text_rarity }}</p>
              <p><strong>–†–µ–¥–∫–æ—Å—Ç—å —Ñ–æ–Ω–∞:</strong> {{ listing.token.bg_rarity }}</p>
              <p><strong>–û–±—â–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å:</strong> {{ listing.token.overall_rarity }}</p>
              <p><strong>–¶–µ–Ω–∞:</strong> {{ listing.price }} üíé</p>
              <p><strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong> {{ users.get(listing.seller_id, {}).get('username', listing.seller_id) }}</p>
              {% if listing.token.bg_availability %}
                <p><strong>–ù–∞–ª–∏—á–∏–µ:</strong> {{ listing.token.bg_availability | replace("–ù–∞–ª–∏—á–∏–µ: ", "") | replace("/", " –∏–∑ ") }}</p>
              {% endif %}
            </div>
          </div>
          <div class="modal-footer d-flex flex-column">
            {% if user_id == listing.seller_id %}
              <button type="button" class="btn btn-warning btn-block w-100 mb-2" data-toggle="modal" data-target="#updatePriceModal-{{ listing.token.token }}">–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</button>
              <form action="/withdraw" method="post" class="w-100 mb-2">
                <input type="hidden" name="market_index" value="{{ listing.token.token }}">
                <button type="submit" class="btn btn-danger btn-block w-100">–°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏</button>
              </form>
            {% else %}
              <button type="button" class="btn btn-primary btn-block mb-2 buy-btn-modal" data-token="{{ listing.token.token }}" data-price="{{ listing.price }}">–ö—É–ø–∏—Ç—å</button>
              <button type="button" class="btn btn-info btn-block w-100 mb-2" data-toggle="modal" data-target="#offerModal-{{ listing.token.token }}">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É</button>
            {% endif %}
            <button type="button" class="btn btn-secondary btn-block w-100" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    {% if user_id == listing.seller_id %}
      <!-- Update price modal -->
      <div class="modal fade" id="updatePriceModal-{{ listing.token.token }}" tabindex="-1" role="dialog" aria-labelledby="updatePriceModalLabel-{{ listing.token.token }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header token-details">
              <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</h5>
              <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <form action="/updateprice" method="post">
              <div class="modal-body">
                <input type="hidden" name="market_index" value="{{ listing.token.token }}">
                <div class="form-group">
                  <label for="newPriceInput-{{ listing.token.token }}">–ù–æ–≤–∞—è —Ü–µ–Ω–∞</label>
                  <input type="number" class="form-control" id="newPriceInput-{{ listing.token.token }}" name="new_price" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É" required>
                </div>
              </div>
              <div class="modal-footer d-flex flex-column">
                <button type="submit" class="btn btn-warning btn-block w-100 mb-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary btn-block w-100" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Offer modal -->
    <div class="modal fade" id="offerModal-{{ listing.token.token }}" tabindex="-1" role="dialog" aria-labelledby="offerModalLabel-{{ listing.token.token }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è –Ω–æ–º–µ—Ä–∞ {{ listing.token.token }}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><span aria-hidden="true">&times;</span></button>
          </div>
          <form action="/offer" method="post">
            <div class="modal-body">
              <input type="hidden" name="token_value" value="{{ listing.token.token }}">
              <div class="form-group">
                <label for="offerPriceInput-{{ listing.token.token }}">–í–∞—à–∞ —Ü–µ–Ω–∞ (üíé):</label>
                <input type="number" class="form-control" id="offerPriceInput-{{ listing.token.token }}" name="proposed_price" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—É—é —Ü–µ–Ω—É" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- –ü—Ä–æ—á–∏–µ –º–æ–¥–∞–ª–∫–∏ -->
  <div class="modal fade" id="tokenSearchModal" tabindex="-1" role="dialog" aria-labelledby="tokenSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form onsubmit="return redirectToToken(event);">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">–ù–∞–π—Ç–∏ NFT –Ω–æ–º–µ—Ä</h5>
            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="tokenNumberInput">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä NFT –Ω–æ–º–µ—Ä–∞</label>
              <input type="text" class="form-control" id="tokenNumberInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1234" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">–ò—Å–∫–∞—Ç—å</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">–û—à–∏–±–∫–∞</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.</div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="swapSuccessModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center">–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div><div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal">–û–∫</button></div></div></div>
  </div>

  <div class="modal fade" id="confirmBuyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å –Ω–æ–º–µ—Ä <strong id="confirmBuyToken"></strong> –∑–∞ <strong id="confirmBuyPrice"></strong> üíé?</div>
      <div class="modal-footer d-flex flex-column">
        <form id="confirmBuyForm" method="post" action="">
          <input type="hidden" name="buyer_id" value="{{ buyer_id }}">
          <button type="submit" class="btn btn-success btn-block mb-2">–î–∞, –∫—É–ø–∏—Ç—å</button>
        </form>
        <button class="btn btn-secondary btn-block" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div></div>
  </div>

  <button id="scrollToTopBtn" onclick="scrollToTop()">&#8593;</button>

  <!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
  $(function(){
    // –ü–æ–∫—É–ø–∫–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    $(document).on('click', '.buy-btn, .buy-btn-modal', function(){
      $('#confirmBuyToken').text(this.dataset.token);
      $('#confirmBuyPrice').text(this.dataset.price);
      $('#confirmBuyForm').attr('action', '/buy/' + encodeURIComponent(this.dataset.token));
      $('.modal.show').modal('hide');
      $('#confirmBuyModal').modal('show');
    });

    $('#confirmBuyForm').on('submit', function(e){
      e.preventDefault();
      const $form = $(this),
            url   = $form.attr('action'),
            data  = $form.serialize();

      $('#confirmBuyModal').modal('hide');

      fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest'},
        body: data
      })
      .then(res => res.ok ? res.json() : Promise.reject())
      .then(json => {
        if (json.new_balance != null) {
          $('#balanceValue').text(json.new_balance + ' üíé');
          $('#swapSuccessModal').modal('show');
          if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
          }
        } else {
          $('#errorModal').modal('show');
        }
      })
      .catch(err => {
        console.error('Buy error:', err);
        $('#errorModal').modal('show');
      });
    });

    // Share buttons
    document.querySelectorAll('[id^="shareBtn-"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const token = btn.dataset.token;
        const botUsername = "{{ BOT_USERNAME if BOT_USERNAME is defined else 'tthnftbot' }}";
        const webAppLink = `https://t.me/${botUsername}?startapp=${encodeURIComponent(token)}`;
        const shareLink = "https://t.me/share/url?url=" + encodeURIComponent(webAppLink) + "&text=" + encodeURIComponent(`–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —ç—Ç–æ—Ç NFT-–Ω–æ–º–µ—Ä ${token}!`);
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.shareData) {
          Telegram.WebApp.shareData({ url: webAppLink, text: `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —ç—Ç–æ—Ç NFT-–Ω–æ–º–µ—Ä ${token}!` });
        } else {
          window.location.href = shareLink;
        }
      });
    });

    // –∞–≤—Ç–æ–ø–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É
    let token = null;
    if (window.Telegram && Telegram.WebApp) {
      token = Telegram.WebApp.startParam || (Telegram.WebApp.initDataUnsafe || {}).start_param;
    }
    if (!token) {
      const params = new URLSearchParams(window.location.search);
      token = params.get('startapp') || params.get('token');
    }
    if (token) {
      token = decodeURIComponent(token);
      $(`#listingModal-${token}`).modal('show');
    }

    // toggle sort
    $("#toggle-sort").click(function(){
      $("#sort-options").slideToggle();
      var arrow = $("#sort-arrow");
      arrow.html(arrow.html() === "&#9660;" ? "&#9650;" : "&#9660;");
    });

    // sort buttons
    $(".sort-btn").click(function(){
      var sortType = $(this).data("sort");
      $(".tab-pane.active .row").each(function(){
        var cards = $(this).children(".col-md-6").get();
        cards.sort(function(a, b){
          var aElem = $(a).find(".market-card");
          var bElem = $(b).find(".market-card");
          var aValue, bValue;
          if(sortType === "token-length-asc"){
            aValue = parseInt(aElem.data("token-length"));
            bValue = parseInt(bElem.data("token-length"));
            return aValue - bValue;
          } else if(sortType === "repeats-desc"){
            aValue = parseInt(aElem.data("repeats"));
            bValue = parseInt(bElem.data("repeats"));
            return bValue - aValue;
          } else if(sortType === "bg-rarity-asc"){
            aValue = parseFloat(aElem.data("bg-rarity"));
            bValue = parseFloat(bElem.data("bg-rarity"));
            return aValue - bValue;
          } else if(sortType === "price-asc"){
            aValue = parseInt(aElem.data("price"));
            bValue = parseInt(bElem.data("price"));
            return aValue - bValue;
          } else if(sortType === "price-desc"){
            aValue = parseInt(aElem.data("price"));
            bValue = parseInt(bElem.data("price"));
            return bValue - aValue;
          }
        });
        $.each(cards, function(idx, card){
          $(this).appendTo($(this).parent());
        });
      });
    });

    // bg filter build
    function getBgDisplayInfo(color) {
      if(!color) return { type: "color", name: "–ù–µ —É–∫–∞–∑–∞–Ω–æ", value: "#fff" };
      if(color.indexOf("/static/image/") === 0){
        var parts = color.split("/");
        var filename = parts[parts.length - 1];
        var name = filename.split(".")[0];
        return { type: "image", name: name, value: color };
      } else {
        var name = color;
        return { type: "color", name: name, value: color };
      }
    }

    var colors = {};
    $(".market-card").each(function(){
      var color = $(this).data("bg-color");
      if(color && color.trim() !== "") colors[color] = color;
    });
    var $filterUl = $("#custom-bg-filter ul");
    $filterUl.empty();
    $filterUl.append('<li data-color=""><div class="color-circle" style="background: #fff;"></div><span>–í—Å–µ —Ü–≤–µ—Ç–∞</span></li>');
    $.each(colors, function(color, val){
      var info = getBgDisplayInfo(color);
      if(info.type === "image"){
        $filterUl.append('<li data-color="'+color+'"><div class="color-circle" style="background-image: url('+info.value+'); background-size: cover; background-position: center;"></div><span>'+info.name+'</span></li>');
      } else {
        $filterUl.append('<li data-color="'+color+'"><div class="color-circle" style="background: '+info.value+';"></div><span>'+info.name+'</span></li>');
      }
    });

    $("#custom-bg-filter .selected").click(function(){ $("#custom-bg-filter ul").slideToggle(); });
    $("#custom-bg-filter ul li").click(function(){
      var selected = $(this).data("color");
      var name = $(this).find("span").text();
      if(selected && selected.indexOf("/static/image/") === 0){
        $("#custom-bg-filter .selected").html('<div class="color-circle" style="background-image: url('+selected+'); background-size: cover; background-position: center;"></div><span>'+name+'</span>');
      } else {
        $("#custom-bg-filter .selected").html('<div class="color-circle" style="background: '+(selected || "#fff")+';"></div><span>'+name+'</span>');
      }
      $("#custom-bg-filter ul").slideUp();
      $(".market-card").each(function(){
        var cardColor = $(this).data("bg-color");
        if(selected === "" || cardColor === selected) $(this).closest(".col-md-6").show(); else $(this).closest(".col-md-6").hide();
      });
    });
  });

  function redirectToToken(event) {
    event.preventDefault();
    var tokenNumber = document.getElementById('tokenNumberInput').value.trim();
    if(tokenNumber) window.location.href = "/token/" + encodeURIComponent(tokenNumber);
    return false;
  }

  function scrollToTop() {
    var content = document.querySelector('.content');
    content.scrollTo({ top: 0, behavior: 'smooth' });
  }

  document.addEventListener('DOMContentLoaded', function() {
    var content = document.querySelector('.content');
    var scrollBtn = document.getElementById('scrollToTopBtn');
    content.addEventListener('scroll', function() {
      if (content.scrollTop > 300) scrollBtn.style.display = 'flex'; else scrollBtn.style.display = 'none';
    });
  });

  // Telegram WebApp integration (if used)
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    if (Telegram.WebApp.HapticFeedback) {
      document.querySelectorAll('button, a.btn, .btn-icon, input[type="submit"]').forEach(el => {
        el.addEventListener('click', () => Telegram.WebApp.HapticFeedback.impactOccurred('light'));
      });
      $('#errorModal').on('show.bs.modal', () => Telegram.WebApp.HapticFeedback.notificationOccurred('error'));
    }
  }
  </script>
</body>
  </html>
